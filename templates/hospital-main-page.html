{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Hospital Dashboard - We Donate</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }
        
        .navbar-custom {
            background: linear-gradient(135deg, #2c5aa0, #1e3c72) !important;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.8rem;
            color: white !important;
        }
        
        .nav-tabs {
            background: white;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 2rem;
        }
        
        .nav-tabs .nav-link {
            border: none;
            color: #666;
            font-weight: 600;
            padding: 1rem 1.5rem;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #2c5aa0, #1e3c72);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .nav-tabs .nav-link:hover {
            background: #f8f9fa;
            color: #2c5aa0;
        }
        
        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            min-height: 500px;
        }
        
        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        
        .card-header-custom {
            background: linear-gradient(135deg, #2c5aa0, #1e3c72);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #2c5aa0, #1e3c72);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0 5px;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 90, 160, 0.4);
            color: white;
        }
        
        .btn-approve {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .btn-deny {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }
        
        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .table-custom thead {
            background: linear-gradient(135deg, #2c5aa0, #1e3c72);
            color: white;
        }
        
        .table-custom tbody tr:hover {
            background: #f8f9fa;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-denied {
            background: #f8d7da;
            color: #721c24;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .search-container {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .form-control {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #2c5aa0;
            box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25);
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container">
        <a class="navbar-brand" href="{% url 'wedonate' %}">
            <i class="fas fa-heart text-danger"></i> We Donate - Hospital Portal
        </a>
        <div class="navbar-nav ml-auto">
            <a class="nav-link text-white" href="{% url 'hospital-logout' %}">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>
</nav>

<div class="container-fluid">
{% csrf_token %}
<ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" data-toggle="tab" href="#home">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#appointment_approvals">
            <i class="fas fa-calendar-check"></i> Appointments <span class="badge badge-warning ml-1" id="appointmentBadge">0</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#donation_approvals">
            <i class="fas fa-hand-holding-heart"></i> Donations <span class="badge badge-warning ml-1" id="donationBadge">0</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-toggle="tab" href="#search_donation">
            <i class="fas fa-search"></i> Search
        </a>
    </li>
    <li class="nav-item ml-auto">
        <a class="nav-link" data-toggle="tab" href="#update_profile">
            <i class="fas fa-user-cog"></i> Profile
        </a>
    </li>
</ul>
<div class="tab-content">
    <!-- Dashboard Tab -->
    <div id="home" class="tab-pane active">
        <h3 class="mb-4"><i class="fas fa-tachometer-alt text-primary"></i> Hospital Dashboard</h3>
        
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card card-custom" id="appointDiv" onclick="switchTab('appointment_approvals')">
                    <div class="card-header card-header-custom">
                        <i class="fas fa-calendar-check"></i> Pending Appointments
                    </div>
                    <div class="card-body text-center">
                        <h2 class="text-primary mb-3" id="appointmentCount">0</h2>
                        <p class="card-text">Appointments waiting for your approval</p>
                        <small class="text-muted">Click to manage appointments</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-4">
                <div class="card card-custom" id="donationsDiv" onclick="switchTab('donation_approvals')">
                    <div class="card-header card-header-custom">
                        <i class="fas fa-hand-holding-heart"></i> Pending Donations
                    </div>
                    <div class="card-body text-center">
                        <h2 class="text-primary mb-3" id="donationCount">0</h2>
                        <p class="card-text">Donation requests awaiting review</p>
                        <small class="text-muted">Click to manage donations</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card card-custom">
                    <div class="card-header card-header-custom">
                        <i class="fas fa-chart-line"></i> Quick Stats
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h4 class="text-success" id="approvedCount">0</h4>
                                <small class="text-muted">Approved This Month</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="text-info" id="totalCount">0</h4>
                                <small class="text-muted">Total Processed</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="text-warning" id="pendingTotal">0</h4>
                                <small class="text-muted">Pending Review</small>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-sm btn-primary" onclick="loadDashboardData()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                                <small class="text-muted d-block">Manual Refresh</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Appointments Tab -->
    <div id="appointment_approvals" class="tab-pane fade">
        <h3 class="mb-4"><i class="fas fa-calendar-check text-primary"></i> Pending Appointments</h3>
        
        <div class="table-responsive">
            <table class="table table-custom" id="appointmentTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllAppointments"></th>
                        <th>ID</th>
                        <th>Donor Name</th>
                        <th>Organ Type</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="appointmentsTableBody">
                    <!-- Sample data - replace with dynamic content -->
                    <tr>
                        <td><input type="checkbox" class="appointment-checkbox" value="1"></td>
                        <td>#APT001</td>
                        <td>John Doe</td>
                        <td>Kidney</td>
                        <td>2024-01-15</td>
                        <td>10:00 AM</td>
                        <td><span class="status-pending">Pending</span></td>
                        <td>
                            <button class="btn btn-sm btn-custom" onclick="viewDetails(1, 'appointment')">Details</button>
                            <button class="btn btn-sm btn-approve" onclick="approveItem(1, 'appointment')">Approve</button>
                            <button class="btn btn-sm btn-deny" onclick="denyItem(1, 'appointment')">Deny</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="mt-3">
            <button class="btn btn-custom" id="appointmentDtls">View Selected Details</button>
            <button class="btn btn-approve" id="appointmentApprv">Approve Selected</button>
            <button class="btn btn-deny" id="appointmentDeny">Deny Selected</button>
        </div>
    </div>
    <!-- Donations Tab -->
    <div id="donation_approvals" class="tab-pane fade">
        <h3 class="mb-4"><i class="fas fa-hand-holding-heart text-primary"></i> Pending Donations</h3>
        
        <div class="table-responsive">
            <table class="table table-custom" id="donationTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllDonations"></th>
                        <th>ID</th>
                        <th>Donor Name</th>
                        <th>Organ Type</th>
                        <th>Blood Group</th>
                        <th>Request Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="donationTableBody">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <div class="mt-3">
            <button class="btn btn-custom" id="donationDtls">View Selected Details</button>
            <button class="btn btn-approve" id="donationApprv">Approve Selected</button>
            <button class="btn btn-deny" id="donationDeny">Deny Selected</button>
        </div>
    </div>
    <!-- Search Tab -->
    <div id="search_donation" class="tab-pane fade">
        <h3 class="mb-4"><i class="fas fa-search text-primary"></i> Search Donations</h3>
        
        <div class="search-container">
            <div class="row">
                <div class="col-md-10">
                    <input type="text" class="form-control" id="searchInput" placeholder="Search by Organ, Donor name, Donation ID, or Blood Group">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-custom btn-block" id="search_btn">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
            </div>
        </div>
        
        <h5 class="mb-3">Search Results:</h5>
        <div class="table-responsive">
            <table class="table table-custom" id="donationSearchTable">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllSearch"></th>
                        <th>ID</th>
                        <th>Donor Name</th>
                        <th>Organ Type</th>
                        <th>Blood Group</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="searchTableBody">
                    <!-- Search results will be populated here -->
                </tbody>
            </table>
        </div>
        
        <div class="mt-3">
            <button class="btn btn-custom" id="searchDtls">View Details</button>
            <button class="btn btn-custom" id="searchEmail">
                <i class="fas fa-envelope"></i> Email Donor
            </button>
        </div>
    </div>
    <!-- Tab content for the Search donation page Ends -->
    <!-- Tab content for the Update profile page Starts -->
    <div id="update_profile" class="tab-pane fade">
      <!-- <div class = "update-flex">
        <form id = "hospitalUpdateForm" class="div-highlight">
          <div class="update-flex-child1 form-row">
            <div class="form-group col-md-12">
              <label for="updateName">Hospital ID</label>
              <input type="text" class="form-control" id="hospitalID" placeholder="600028" readonly>
            </div>
             <div class="form-group col-md-12">
              <label for="updateName">Hospital name</label>
              <input type="text" class="form-control" id="updateName" value = "IWK Hospital" required>
            </div>
            <div class="form-group col-md-12">
              <label for="updateEmail">Email</label>
              <input type="email" class="form-control" id="updateEmail" value = "iwkadmin@iwk.ca" required>
            </div>
            <div class="form-group col-md-12">
              <label for="updateContact">Contact Number</label>
              <input type="text" class="form-control" id="updateContact" value = "+1 902-412-1234" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group col-md-4">
              <label for="updateCity">City</label>
              <input type="text" class="form-control" id="updateCity" value= "Halifax" required>
            </div>
            <div class="form-group col-md-4">
              <label for="updateState">State</label>
              <select id="updateState" class="form-control">
                <option>Select</option>
                <option selected>Nova Scotia</option>
                <option>Ontario</option>
                <option>...</option>
              </select>
            </div>
            <div class="form-group col-md-2">
              <label for="updateZip">Zip</label>
              <input type="text" class="form-control" id="updateZip" value = "B3J 2K9" required>
            </div>
            <div class="form-group col-md-2">
              <label for="updateCountry">Country</label>
              <input type="text" class="form-control" id="updateCountry" value = "Canada" required>
            </div>
          </div>
          <div class="form-group cpChild2">
            <label for="newPassword">New Password</label>
            <input type="password" class="form-control" id="newPassword" placeholder="New Password">
          </div>
          <div class="form-group cpChild3">
            <label for="confirm_new_Password">Confirm New Password</label>
            <input type="password" class="form-control" id="confirm_new_Password" placeholder="Confirm Password">
          </div>
          <div class="update-flex-child2">
          <input type="submit" class="blue buttons" id = "updateSave" value = "Save changes">
          <input type = "reset" class="blue buttons" value = "Restore to defaults" id = "updateClear">
          </div>
        </form>
        </div> -->
        <div class="container">
        <div class="row">
        <div class="col-md-6">
        <div class="card bg-light mb-3">
        <header class="card-header bg-light mb-3">
                <button class="btn btn-warning float-right mt-1 bg-for-all" type="reset" onclick="enableedituserprofile();">
                    <i class="fa fa-edit"></i>&nbsp;Edit
                </button>
            <h4 class="card-title bg-light mb-3" style="color: black">User profile</h4>
        </header>

        <div class="card-content">
        <form id = "updateDetailsForm">
            <!-- {% csrf_token %} -->
           <!--  <div class="form-group">
                {% if success and pfcheck %} {{msg}} {% endif %}

            </div> -->
            <div class="form-group">
                <span class="input-group-addon"><i class="fa fa-user"></i></span>
                <label>Hospital name</label>
                <input type="text" name="hospital_name" id="hospitalName" class="form-control" placeholder="" required disabled>
            </div>
            <div class="form-group">
                <span class="input-group-addon"><i class="fa fa-at"></i></span>
                <label>Email address</label>
                <input type="email" class="form-control" name="email" placeholder="" id="emailHospital" disabled required>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                <span class="input-group-addon"><i class="fa fa-building"></i></span>
                <label>City</label>
                <input type="text" id="city" name="city" class="form-control" disabled>
                </div>
                <div class="form-group col-md-6">
                    <span class="input-group-addon"><i class="fa fa-building"></i></span>
                    <label>Province</label>
                    <select id="input-province" name="province" value="Ontario" class="form-control" disabled>
                        <option value="Nova Scotia">Nova Scotia</option>
                        <option value="British Columbia">British Columbia</option>
                        <option value="Ontario">Ontario</option>
                        <option value="Quebec">Quebec</option>
                        <option value="Alberta">Alberta</option>
                        <option value="New Brunswick">New Brunswick</option>
                        <option value="Manitoba">Manitoba</option>
                        <option value="Sasketchawan"
                        >Sasketchawan</option>
                        <option value="New Foundland and Labrador">New Foundland and Labrador</option>
                        <option value="Prince Edward Island">Prince Edward Island</option>
                    </select>
                    </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                <span class="input-group-addon"><i class="fa fa-mobile"></i></span>
                <label>Contact no. (+1)</label>
                <input type="text" id="hospitalContact" name="contact" class="form-control" maxlength="10" minlength="10" disabled>
                </div>
                <div class="form-group col-md-6">
                <span class="input-group-addon"><i class="fa fa-building"></i></span>
                <label>Country</label>
                <select id="input-country" name="country" class="form-control" disabled>
                    <option selected="">Canada</option>
                </select>
                </div>
            </div>
            <div class="form-group">
            </div>
            <div class="form-group">
                <button name="profile" type="submit" id="submitUpdateProf" class="btn navbar-bg btn-block blue buttons" disabled> Update </button>
            </div>


        </div>
        </div>
        </div>
        <div class="col-md-6">
                <div class="card bg-light mb-3">
                <header class="card-header bg-light mb-3">
                        <button class="btn btn-warning float-right mt-1 bg-for-all" onclick="enableeditpasswords();">
                                <i class="fa fa-edit"></i>&nbsp;Edit
                        </button>
                    <h4 class="card-title mt-2 black bg-light mb-3" style="color: black">Password details</h4>
                </header>
                <div class="card-content">

                    <!-- <div class="form-group">
                        {% if success and pscheck %} {{msg}} {% endif %}
                    </div> -->
                    <div class="form-group">
                        <span class="input-group-addon"><i class="fa fa-lock"></i></span>
                        <label>Old password</label>
                        <input type="password" id="password1" name="old_password" class="form-control" disabled required>
                    </div>

                    <div class="form-group">
                        <span class="input-group-addon"><i class="fa fa-lock"></i></span>
                        <label>New password</label>
                        <input class="form-control" type="password" name="new_password" minlength="6" pattern="(?=.*[a-z])(?=.*\d).{6,}" title="Please include 1 uppercase letter, 1 lowercase letter and 1 digit in your password" id="password2" disabled required>
                    </div>
                    <div class="form-group">
                        <span class="input-group-addon"><i class="fa fa-lock"></i></span>
                        <label>Confirm password</label>
                        <input class="form-control" type="password" id="password3" oninput="checkpassword();" disabled required>
                    </div>
                    <div class="form-group">
                        <span id="password-validation-msg"></span>
                    </div>
                    <div class="form-group">
                        <button name="password" type="submitPwd" id="update-password" class="btn navbar-bg btn-block blue buttons" disabled> Update </button>
                    </div>

                </form>
                </div>
                </div>
                </div>
        </div>
    </div>

</div>

<footer class="bg-dark text-white text-center py-3 mt-5">
    <div class="container">
        <p class="mb-0">&copy; 2024 We Donate Inc. All rights reserved. | 
        <a href="#" class="text-light">Privacy Policy</a> | 
        <a href="#" class="text-light">Contact Us</a></p>
    </div>
</footer>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Modern JavaScript for hospital dashboard
// Make loadDashboardData globally accessible
window.loadDashboardData = function() {
    // Fetch appointment count
    $.get('{% url "fetch-counts" %}', function(data) {
        console.log('Raw fetch-counts response:', data);
        console.log('Type of data:', typeof data);
        console.log('Appointments value:', data.appointments);
        console.log('Donations value:', data.donations);
        
        let appointments = parseInt(data.appointments) || 0;
        let donations = parseInt(data.donations) || 0;
        
        console.log('Parsed appointments:', appointments);
        console.log('Parsed donations:', donations);
        
        $('#appointmentCount').text(appointments);
        $('#donationCount').text(donations);
        console.log('Setting donation count to:', donations);
        $('#appointmentBadge').text(appointments);
        $('#donationBadge').text(donations);
        $('#pendingTotal').text(appointments + donations);
    }).fail(function(xhr, status, error) {
        console.log('Failed to load dashboard data:', error);
        console.log('Response text:', xhr.responseText);
        $('#appointmentCount').text('Error');
        $('#donationCount').text('Error');
    });
    
    // Load appointments and donations
    if (typeof window.loadAppointments === 'function') {
        loadAppointments();
    }
    if (typeof window.loadDonations === 'function') {
        loadDonations();
    }
};

$(document).ready(function() {
    // Load initial data
    loadDashboardData();
    
    // Tab switching function
    window.switchTab = function(tabId) {
        $('.nav-tabs a[href="#' + tabId + '"]').tab('show');
    };
    

    
    // Load appointments table
    window.loadAppointments = function() {
        $.get('{% url "fetch-appointments" %}', function(data) {
            let tbody = $('#appointmentsTableBody');
            tbody.empty();
            
            if (data.appointments && data.appointments.length > 0) {
                data.appointments.forEach(function(apt) {
                    tbody.append(`
                        <tr>
                            <td><input type="checkbox" class="appointment-checkbox" value="${apt.id}"></td>
                            <td>#APT${apt.id}</td>
                            <td>${apt.donor_name}</td>
                            <td>${apt.organ_type}</td>
                            <td>${apt.date}</td>
                            <td>${apt.time}</td>
                            <td><span class="status-${apt.status.toLowerCase()}">${apt.status}</span></td>
                            <td>
                                <button class="btn btn-sm btn-custom" onclick="viewDetails(${apt.id}, 'appointment')">Details</button>
                                <button class="btn btn-sm btn-approve" onclick="approveItem(${apt.id}, 'appointment')">Approve</button>
                                <button class="btn btn-sm btn-deny" onclick="denyItem(${apt.id}, 'appointment')">Deny</button>
                            </td>
                        </tr>
                    `);
                });
            } else {
                tbody.append('<tr><td colspan="8" class="text-center">No pending appointments</td></tr>');
            }
        }).fail(function() {
            console.log('Failed to load appointments');
        });
    };
    
    // Load donations table
    window.loadDonations = function() {
        console.log('Loading donations...');
        $.get('{% url "fetch-donations" %}', function(data) {
            console.log('Donations response:', data);
            let tbody = $('#donationTableBody');
            tbody.empty();
            
            if (data.donations && data.donations.length > 0) {
                console.log('Found', data.donations.length, 'donations');
                data.donations.forEach(function(don) {
                    console.log('Processing donation:', don);
                    tbody.append(`
                        <tr>
                            <td><input type="checkbox" class="donation-checkbox" value="${don.id}"></td>
                            <td>#DON${don.id}</td>
                            <td>${don.donor_name}</td>
                            <td>${don.organ_type}</td>
                            <td>${don.blood_type}</td>
                            <td>${don.request_date}</td>
                            <td><span class="status-${don.status.toLowerCase()}">${don.status}</span></td>
                            <td>
                                <button class="btn btn-sm btn-custom" onclick="viewDetails(${don.id}, 'donation')">Details</button>
                                <button class="btn btn-sm btn-approve" onclick="approveItem(${don.id}, 'donation')">Approve</button>
                                <button class="btn btn-sm btn-deny" onclick="denyItem(${don.id}, 'donation')">Deny</button>
                            </td>
                        </tr>
                    `);
                });
            } else {
                console.log('No donations found or empty response');
                tbody.append('<tr><td colspan="8" class="text-center">No pending donations</td></tr>');
            }
        }).fail(function(xhr, status, error) {
            console.log('Failed to load donations:', error);
            console.log('Response text:', xhr.responseText);
        });
    };
    
    // Approve item function
    window.approveItem = function(id, type) {
        Swal.fire({
            title: 'Approve ' + type.charAt(0).toUpperCase() + type.slice(1),
            text: 'Are you sure you want to approve this ' + type + '?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, approve it!'
        }).then((result) => {
            if (result.isConfirmed) {
                let url = type === 'appointment' ? '{% url "appointments-approval" %}' : '{% url "donations-approval" %}';
                $.post(url, {
                    'action': 'approve',
                    'id': id,
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                }, function(data) {
                    if (data.success) {
                        Swal.fire('Approved!', type.charAt(0).toUpperCase() + type.slice(1) + ' has been approved.', 'success');
                        loadDashboardData();
                    } else {
                        Swal.fire('Error!', 'Failed to approve ' + type, 'error');
                    }
                });
            }
        });
    };
    
    // Deny item function
    window.denyItem = function(id, type) {
        Swal.fire({
            title: 'Deny ' + type.charAt(0).toUpperCase() + type.slice(1),
            text: 'Are you sure you want to deny this ' + type + '?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, deny it!'
        }).then((result) => {
            if (result.isConfirmed) {
                let url = type === 'appointment' ? '{% url "appointments-approval" %}' : '{% url "donations-approval" %}';
                $.post(url, {
                    'action': 'deny',
                    'id': id,
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                }, function(data) {
                    if (data.success) {
                        Swal.fire('Denied!', type.charAt(0).toUpperCase() + type.slice(1) + ' has been denied.', 'success');
                        loadDashboardData();
                    } else {
                        Swal.fire('Error!', 'Failed to deny ' + type, 'error');
                    }
                });
            }
        });
    };
    
    // View details function
    window.viewDetails = function(id, type) {
        let url = type === 'appointment' ? '{% url "fetch-appointment-details" %}' : '{% url "fetch-donation-details" %}';
        $.get(url, {'id': id}, function(data) {
            let content = '<div class="text-left">';
            Object.keys(data).forEach(key => {
                if (key !== 'success') {
                    content += `<p><strong>${key.replace('_', ' ').toUpperCase()}:</strong> ${data[key]}</p>`;
                }
            });
            content += '</div>';
            
            Swal.fire({
                title: type.charAt(0).toUpperCase() + type.slice(1) + ' Details',
                html: content,
                width: '600px',
                confirmButtonText: 'Close'
            });
        });
    };
    
    // Search functionality
    $('#search_btn').click(function() {
        let searchTerm = $('#searchInput').val();
        if (searchTerm.trim() === '') {
            Swal.fire('Error', 'Please enter a search term', 'error');
            return;
        }
        
        $.get('{% url "search-donations" %}', {'search': searchTerm}, function(data) {
            let tbody = $('#searchTableBody');
            tbody.empty();
            
            if (data.results && data.results.length > 0) {
                data.results.forEach(function(item) {
                    tbody.append(`
                        <tr>
                            <td><input type="checkbox" class="search-checkbox" value="${item.id}"></td>
                            <td>#DON${item.id}</td>
                            <td>${item.donor_name}</td>
                            <td>${item.organ_type}</td>
                            <td>${item.blood_type}</td>
                            <td><span class="status-${item.status.toLowerCase()}">${item.status}</span></td>
                            <td>
                                <button class="btn btn-sm btn-custom" onclick="viewDetails(${item.id}, 'donation')">Details</button>
                                <button class="btn btn-sm btn-custom" onclick="emailDonor(${item.id})">Email</button>
                            </td>
                        </tr>
                    `);
                });
            } else {
                tbody.append('<tr><td colspan="7" class="text-center">No results found</td></tr>');
            }
        });
    });
    
    // Email donor function
    window.emailDonor = function(donorId) {
        Swal.fire({
            title: 'Email Donor',
            text: 'Send email notification to donor?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Send Email'
        }).then((result) => {
            if (result.isConfirmed) {
                $.get('{% url "email-donor" donor_id=0 %}'.replace('0', donorId), function(data) {
                    if (data.success) {
                        Swal.fire('Sent!', 'Email has been sent to the donor.', 'success');
                    } else {
                        Swal.fire('Error!', 'Failed to send email.', 'error');
                    }
                });
            }
        });
    };
    
    // Bulk actions for appointments
    $('#appointmentDtls').click(function() {
        let selected = $('.appointment-checkbox:checked');
        if (selected.length === 0) {
            Swal.fire('Error', 'Please select at least one appointment', 'error');
            return;
        }
        if (selected.length > 1) {
            Swal.fire('Error', 'Please select only one appointment to view details', 'error');
            return;
        }
        viewDetails(selected.val(), 'appointment');
    });
    
    $('#appointmentApprv').click(function() {
        let selected = $('.appointment-checkbox:checked');
        if (selected.length === 0) {
            Swal.fire('Error', 'Please select at least one appointment', 'error');
            return;
        }
        
        Swal.fire({
            title: 'Approve Selected Appointments',
            text: `Are you sure you want to approve ${selected.length} appointment(s)?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            confirmButtonText: 'Yes, approve them!'
        }).then((result) => {
            if (result.isConfirmed) {
                let promises = [];
                selected.each(function() {
                    promises.push($.post('{% url "appointments-approval" %}', {
                        'action': 'approve',
                        'id': $(this).val(),
                        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                    }));
                });
                
                Promise.all(promises).then(() => {
                    Swal.fire('Approved!', 'Selected appointments have been approved.', 'success');
                    loadDashboardData();
                });
            }
        });
    });
    
    $('#appointmentDeny').click(function() {
        let selected = $('.appointment-checkbox:checked');
        if (selected.length === 0) {
            Swal.fire('Error', 'Please select at least one appointment', 'error');
            return;
        }
        
        Swal.fire({
            title: 'Deny Selected Appointments',
            text: `Are you sure you want to deny ${selected.length} appointment(s)?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'Yes, deny them!'
        }).then((result) => {
            if (result.isConfirmed) {
                let promises = [];
                selected.each(function() {
                    promises.push($.post('{% url "appointments-approval" %}', {
                        'action': 'deny',
                        'id': $(this).val(),
                        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                    }));
                });
                
                Promise.all(promises).then(() => {
                    Swal.fire('Denied!', 'Selected appointments have been denied.', 'success');
                    loadDashboardData();
                });
            }
        });
    });
    
    // Bulk actions for donations
    $('#donationDtls').click(function() {
        let selected = $('.donation-checkbox:checked');
        if (selected.length === 0) {
            Swal.fire('Error', 'Please select at least one donation', 'error');
            return;
        }
        if (selected.length > 1) {
            Swal.fire('Error', 'Please select only one donation to view details', 'error');
            return;
        }
        viewDetails(selected.val(), 'donation');
    });
    
    $('#donationApprv').click(function() {
        let selected = $('.donation-checkbox:checked');
        if (selected.length === 0) {
            Swal.fire('Error', 'Please select at least one donation', 'error');
            return;
        }
        
        Swal.fire({
            title: 'Approve Selected Donations',
            text: `Are you sure you want to approve ${selected.length} donation(s)?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            confirmButtonText: 'Yes, approve them!'
        }).then((result) => {
            if (result.isConfirmed) {
                let promises = [];
                selected.each(function() {
                    promises.push($.post('{% url "donations-approval" %}', {
                        'action': 'approve',
                        'id': $(this).val(),
                        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                    }));
                });
                
                Promise.all(promises).then(() => {
                    Swal.fire('Approved!', 'Selected donations have been approved.', 'success');
                    loadDashboardData();
                });
            }
        });
    });
    
    $('#donationDeny').click(function() {
        let selected = $('.donation-checkbox:checked');
        if (selected.length === 0) {
            Swal.fire('Error', 'Please select at least one donation', 'error');
            return;
        }
        
        Swal.fire({
            title: 'Deny Selected Donations',
            text: `Are you sure you want to deny ${selected.length} donation(s)?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'Yes, deny them!'
        }).then((result) => {
            if (result.isConfirmed) {
                let promises = [];
                selected.each(function() {
                    promises.push($.post('{% url "donations-approval" %}', {
                        'action': 'deny',
                        'id': $(this).val(),
                        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                    }));
                });
                
                Promise.all(promises).then(() => {
                    Swal.fire('Denied!', 'Selected donations have been denied.', 'success');
                    loadDashboardData();
                });
            }
        });
    });
    
    // Select all checkboxes
    $('#selectAllAppointments').change(function() {
        $('.appointment-checkbox').prop('checked', this.checked);
    });
    
    $('#selectAllDonations').change(function() {
        $('.donation-checkbox').prop('checked', this.checked);
    });
    
    // Load user profile data
    function loadUserProfile() {
        $.get('{% url "get-user-details" %}', function(data) {
            if (data.length > 0) {
                let user = data[0];
                $('#hospitalName').val(user.hospital_name || '');
                $('#emailHospital').val(user.hospital_email || '');
                $('#city').val(user.hospital_city || '');
                $('#input-province').val(user.hospital_province || '');
                $('#hospitalContact').val(user.hospital_contact || '');
            }
        });
    }
    
    // Enable profile editing
    window.enableedituserprofile = function() {
        $('#hospitalName, #emailHospital, #city, #input-province, #hospitalContact').prop('disabled', false);
        $('#submitUpdateProf').prop('disabled', false);
    };
    
    // Enable password editing
    window.enableeditpasswords = function() {
        $('#password1, #password2, #password3').prop('disabled', false);
        $('#update-password').prop('disabled', false);
    };
    
    // Update profile form submission
    $('#updateDetailsForm').submit(function(e) {
        e.preventDefault();
        
        $.post('{% url "update-user-details" %}', {
            'name': $('#hospitalName').val(),
            'email': $('#emailHospital').val(),
            'city': $('#city').val(),
            'province': $('#input-province').val(),
            'contact': $('#hospitalContact').val(),
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        }, function(data) {
            if (data === 'success') {
                Swal.fire('Success!', 'Profile updated successfully.', 'success');
                $('#hospitalName, #emailHospital, #city, #input-province, #hospitalContact').prop('disabled', true);
                $('#submitUpdateProf').prop('disabled', true);
            } else {
                Swal.fire('Error!', 'Failed to update profile.', 'error');
            }
        });
    });
    
    // Update password
    $('#update-password').click(function(e) {
        e.preventDefault();
        
        if ($('#password2').val() !== $('#password3').val()) {
            Swal.fire('Error!', 'New passwords do not match.', 'error');
            return;
        }
        
        $.post('{% url "update-pwd-details" %}', {
            'old_password': $('#password1').val(),
            'new_password': $('#password2').val(),
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        }, function(data) {
            if (data === 'success') {
                Swal.fire('Success!', 'Password updated successfully.', 'success');
                $('#password1, #password2, #password3').val('').prop('disabled', true);
                $('#update-password').prop('disabled', true);
            } else {
                Swal.fire('Error!', 'Failed to update password. Check your old password.', 'error');
            }
        });
    });
    
    // Password validation
    window.checkpassword = function() {
        let pass1 = $('#password2').val();
        let pass2 = $('#password3').val();
        let msg = $('#password-validation-msg');
        
        if (pass1 !== pass2) {
            msg.html('<span style="color: red;">Passwords do not match</span>');
        } else if (pass1.length > 0) {
            msg.html('<span style="color: green;">Passwords match</span>');
        } else {
            msg.html('');
        }
    };
    
    // Load profile data when profile tab is shown
    $('a[href="#update_profile"]').on('shown.bs.tab', function() {
        loadUserProfile();
    });
    
    // Load donations when donations tab is shown
    $('a[href="#donation_approvals"]').on('shown.bs.tab', function() {
        console.log('Donations tab clicked - loading donations');
        loadDonations();
    });
});
</script>
</body>
</html>
