{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donor Dashboard - We Donate</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }
        
        .navbar-custom {
            background: linear-gradient(135deg, #667eea, #764ba2) !important;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.8rem;
            color: white !important;
        }
        
        .navbar-nav .nav-link {
            color: rgba(255,255,255,0.9) !important;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .navbar-nav .nav-link:hover {
            color: white !important;
            transform: translateY(-1px);
        }
        
        .dashboard-header {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .welcome-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .table-custom {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .table-custom thead {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .table-custom tbody tr:hover {
            background: #f8f9fa;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-denied {
            background: #f8d7da;
            color: #721c24;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .btn-custom {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .action-buttons {
            text-align: center;
            margin: 2rem 0;
        }
        
        .footer-custom {
            background: #2c3e50;
            color: white;
            padding: 2rem 0;
            text-align: center;
            margin-top: 3rem;
        }
        
        .footer-custom a {
            color: #ecf0f1;
            text-decoration: none;
        }
        
        .footer-custom a:hover {
            color: #667eea;
        }
        
        .dropdown-menu {
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand" href="{% url 'donor-landing-page' %}">
                <i class="fas fa-heart text-danger"></i> We Donate - Donor Portal
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'donor-landing-page' %}">
                            <i class="fas fa-home"></i> Home
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="{% url 'donor-home' %}">
                            <i class="fas fa-history"></i> My Donations
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'new-donation-request' %}">
                            <i class="fas fa-plus-circle"></i> New Request
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'book-appointment' %}">
                            <i class="fas fa-calendar-plus"></i> Book Appointment
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown">
                            <i class="fas fa-user-circle"></i> Settings
                        </a>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" href="{% url 'donor-profile-update' %}">
                                <i class="fas fa-user-edit"></i> Update Profile
                            </a>
                            <a class="dropdown-item" href="{% url 'donor-profile-update' %}">
                                <i class="fas fa-key"></i> Change Password
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="{% url 'donor-logout' %}">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container-fluid" style="margin-top: 100px;">
        <!-- Welcome Section -->
        <div class="container">
            <div class="welcome-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2><i class="fas fa-hand-holding-heart"></i> Welcome back, {{ user.first_name }}!</h2>
                        <p class="mb-0">Thank you for being part of our life-saving mission. Track your donation journey below.</p>
                    </div>
                    <div class="col-md-4 text-right">
                        <a href="{% url 'new-donation-request' %}" class="btn btn-light btn-lg">
                            <i class="fas fa-plus-circle"></i> New Donation
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">{{ donationrequests|length }}</div>
                        <h6>Total Requests</h6>
                        <small class="text-muted">Donation requests made</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">{% for dreq in donationrequests %}{% if dreq.donation_status == 'Approved' %}{{ forloop.counter0|add:1 }}{% endif %}{% empty %}0{% endfor %}</div>
                        <h6>Approved</h6>
                        <small class="text-muted">Successfully approved</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">{% if appointments %}{{ appointments|length }}{% else %}0{% endif %}</div>
                        <h6>Appointments</h6>
                        <small class="text-muted">Scheduled appointments</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <div class="stats-number">{% for dreq in donationrequests %}{% if dreq.donation_status == 'Pending' %}{{ forloop.counter0|add:1 }}{% endif %}{% empty %}0{% endfor %}</div>
                        <h6>Pending</h6>
                        <small class="text-muted">Awaiting review</small>
                    </div>
                </div>
            </div>
            
            <!-- Upcoming Appointments Section -->
            <div class="table-container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-calendar-check text-success"></i> My Appointments</h3>
                    <div>
                        <a href="{% url 'book-appointment' %}" class="btn btn-success btn-sm">
                            <i class="fas fa-plus"></i> Book New
                        </a>
                    </div>
                </div>
                
                {% if appointments %}
                <div class="table-responsive">
                    <table class="table table-custom">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> Appointment ID</th>
                                <th><i class="fas fa-hospital"></i> Hospital</th>
                                <th><i class="fas fa-calendar"></i> Date</th>
                                <th><i class="fas fa-clock"></i> Time</th>
                                <th><i class="fas fa-heart"></i> Donation</th>
                                <th><i class="fas fa-info-circle"></i> Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for appointment in appointments %}
                            <tr>
                                <td><strong>#APT{{ appointment.id }}</strong></td>
                                <td>{{ appointment.hospital.hospital_name|default:appointment.hospital.username }}</td>
                                <td>{{ appointment.date }}</td>
                                <td>{{ appointment.time }}</td>
                                <td><span class="badge badge-info">#DON{{ appointment.donation_request.id }}</span></td>
                                <td>
                                    {% if appointment.appointment_status == 'Pending' %}
                                        <span class="status-pending">Pending</span>
                                    {% elif appointment.appointment_status == 'Approved' %}
                                        <span class="status-approved">Confirmed</span>
                                    {% else %}
                                        <span class="status-denied">{{ appointment.appointment_status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <h5>No Appointments Scheduled</h5>
                    <p>You haven't booked any appointments yet. Book an appointment for your approved donation requests.</p>
                    <small class="text-muted">Debug: appointments variable = {{ appointments|default:"None" }}</small><br>
                    <small class="text-muted">Debug: appointments length = {{ appointments|length|default:"0" }}</small>
                    <br><br>
                    <a href="{% url 'book-appointment' %}" class="btn btn-success">
                        <i class="fas fa-calendar-plus"></i> Book Your First Appointment
                    </a>
                </div>
                {% endif %}
            </div>
            
            <!-- Donation History Table -->
            <div class="table-container">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3><i class="fas fa-history text-primary"></i> My Donation History</h3>
                    <div>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                
                {% if donationrequests %}
                <div class="table-responsive">
                    <table class="table table-custom">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i> ID</th>
                                <th><i class="fas fa-heart"></i> Organ</th>
                                <th><i class="fas fa-tint"></i> Blood Group</th>
                                <th><i class="fas fa-clipboard-check"></i> Donation Status</th>
                                <th><i class="fas fa-calendar-check"></i> Appointment Status</th>
                                <th><i class="fas fa-calendar"></i> Request Date</th>
                                <th><i class="fas fa-cogs"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dreq in donationrequests %}
                            <tr>
                                <td><strong>#DON{{ dreq.id }}</strong></td>
                                <td>
                                    <span class="badge badge-info">{{ dreq.organ_type }}</span>
                                </td>
                                <td>{{ dreq.blood_type }}</td>
                                <td>
                                    {% if dreq.donation_status == 'Pending' %}
                                        <span class="status-pending">{{ dreq.donation_status }}</span>
                                    {% elif dreq.donation_status == 'Approved' %}
                                        <span class="status-approved">{{ dreq.donation_status }}</span>
                                    {% else %}
                                        <span class="status-denied">{{ dreq.donation_status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if dreq.appointment_status == 'Pending' %}
                                        <span class="status-pending">{{ dreq.appointment_status }}</span>
                                    {% elif dreq.appointment_status == 'Approved' %}
                                        <span class="status-approved">{{ dreq.appointment_status }}</span>
                                    {% elif dreq.appointment_status == 'Not Booked' %}
                                        <span class="badge badge-secondary">{{ dreq.appointment_status }}</span>
                                    {% else %}
                                        <span class="status-denied">{{ dreq.appointment_status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ dreq.datetime }}</td>
                                <td>
                                    {% if dreq.appointment_status == 'Not Booked' and dreq.donation_status == 'Approved' %}
                                        <a href="{% url 'book-appointment' %}" class="btn btn-sm btn-success">
                                            <i class="fas fa-calendar-plus"></i> Book
                                        </a>
                                    {% elif dreq.appointment_status == 'Approved' %}
                                        <button class="btn btn-sm btn-info" onclick="viewAppointment({{ dreq.id }})">
                                            <i class="fas fa-calendar-check"></i> View Appointment
                                        </button>
                                    {% else %}
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewDetails({{ dreq.id }})">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-heart-broken"></i>
                    <h4>No Donation Requests Yet</h4>
                    <p>You haven't made any donation requests. Start your life-saving journey today!</p>
                    <a href="{% url 'new-donation-request' %}" class="btn btn-custom btn-lg">
                        <i class="fas fa-plus-circle"></i> Make Your First Donation Request
                    </a>
                </div>
                {% endif %}
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <a href="{% url 'new-donation-request' %}" class="btn btn-custom btn-lg mr-3">
                    <i class="fas fa-plus-circle"></i> New Donation Request
                </a>
                <a href="{% url 'book-appointment' %}" class="btn btn-outline-primary btn-lg">
                    <i class="fas fa-calendar-plus"></i> Book Appointment
                </a>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="footer-custom">
        <div class="container">
            <p class="mb-0">&copy; 2024 We Donate Inc. All rights reserved. | 
            <a href="#">Privacy Policy</a> | 
            <a href="#">Contact Us</a></p>
        </div>
    </footer>
    
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Modern JavaScript for donor dashboard
        $(document).ready(function() {
            // Add smooth animations
            $('.stats-card').each(function(index) {
                $(this).delay(index * 100).fadeIn(500);
            });
        });
        
        // Refresh data function
        function refreshData() {
            location.reload();
        }
        
        // View details function
        function viewDetails(donationId) {
            Swal.fire({
                title: 'Donation Details',
                html: `
                    <div class="text-left">
                        <p><strong>Donation ID:</strong> #DON${donationId}</p>
                        <p><strong>Status:</strong> Processing...</p>
                        <p><strong>Next Steps:</strong> Please wait for hospital approval</p>
                        <p><strong>Contact:</strong> For questions, contact support</p>
                    </div>
                `,
                icon: 'info',
                confirmButtonText: 'Close',
                confirmButtonColor: '#667eea'
            });
        }
        
        // View appointment function
        function viewAppointment(donationId) {
            Swal.fire({
                title: 'Appointment Details',
                html: `
                    <div class="text-left">
                        <p><strong>Donation ID:</strong> #DON${donationId}</p>
                        <p><strong>Status:</strong> Appointment Confirmed</p>
                        <p><strong>Next Steps:</strong> Please arrive 15 minutes early</p>
                        <p><strong>Contact:</strong> Call hospital for any changes</p>
                    </div>
                `,
                icon: 'success',
                confirmButtonText: 'Close',
                confirmButtonColor: '#667eea'
            });
        }
        
        // Success message for new users
        {% if donationrequests|length == 1 %}
        $(document).ready(function() {
            setTimeout(function() {
                Swal.fire({
                    title: 'Welcome to We Donate!',
                    text: 'Thank you for joining our life-saving mission. Your donation request has been submitted.',
                    icon: 'success',
                    confirmButtonColor: '#667eea'
                });
            }, 1000);
        });
        {% endif %}
    </script>
</body>
</html>
